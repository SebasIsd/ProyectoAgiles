@page "/facturas/editar/{Id:int}"
@using System.Net.Http.Json
@using Facturacion.Application.DTOs
@attribute [Authorize]
@using Facturacion.Domain.Entities
@inject FacturaApiService Api
@inject AlertService Alert
@inject NavigationManager Nav
@inject HttpClient Http

<PageTitle>Editar Factura</PageTitle>

@if (factura == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <h3 class="mb-4">Editar Factura @factura.Numero</h3>

    <EditForm Model="@modelo" OnValidSubmit="@Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" />

        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Cliente <span class="text-danger">*</span></label>
                        <InputSelect @bind-Value="modelo.ClienteId" class="form-select">
                            <option value="0">-- Seleccionar cliente --</option>
                            @foreach (var c in clientes)
                            {
                                <option value="@c.Id">@c.Nombre - @c.Identificacion</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha</label>
                        <InputDate @bind-Value="modelo.Fecha" class="form-control" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Productos</strong>
                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AgregarLinea">
                    + Agregar producto
                </button>
            </div>
            <div class="card-body">
                @if (!modelo.Detalles.Any())
                {
                    <p class="text-muted text-center">No hay productos agregados</p>
                }
                else
                {
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in modelo.Detalles)
                            {
                                <tr>
                                    <td>
                                        <InputSelect @bind-Value="item.ProductoId" class="form-select form-select-sm"
                                                     @onchange="() => CargarPrecio(item)">
                                            <option value="0">-- Seleccionar --</option>
                                            @foreach (var p in productos)
                                            {
                                                <option value="@p.Id">@p.Nombre</option>
                                            }
                                        </InputSelect>
                                    </td>
                                    <td>
                                        <InputNumber @bind-Value="item.Cantidad" class="form-control form-control-sm"
                                                     min="1" style="width:80px;" />
                                    </td>
                                    <td>$@item.PrecioUnitario.ToString("0.00")</td>
                                    <td>$@((item.Cantidad * item.PrecioUnitario).ToString("0.00"))</td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                @onclick="() => modelo.Detalles.Remove(item)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

        <div class="mt-4 text-end">
            <h4>TOTAL: $@modelo.Total.ToString("0.00")</h4>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-success btn-lg">
                Actualizar Factura
            </button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar">
                Cancelar
            </button>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }
    private FacturaDto? factura;
    private Modelo modelo = new();
    private List<Cliente> clientes = new();
    private List<Producto> productos = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            clientes = await Http.GetFromJsonAsync<List<Cliente>>("api/clientes") ?? new();
            productos = await Http.GetFromJsonAsync<List<Producto>>("api/productos") ?? new();

            factura = await Api.GetByIdAsync(Id);
            if (factura == null || factura.Estado != "Borrador")
            {
                await Alert.Error("Solo se pueden editar facturas en estado Borrador");
                Nav.NavigateTo("/facturas");
                return;
            }

            // Cargar modelo desde factura existente
            modelo.ClienteId = factura.ClienteId;  // Necesitarás agregar ClienteId al DTO
            modelo.Fecha = factura.FechaEmision;
            modelo.Detalles = factura.Detalles.Select(d => new DetalleModel
            {
                ProductoId = d.ProductoId,  // Necesitarás agregar ProductoId al DTO
                Cantidad = d.Cantidad,
                PrecioUnitario = d.PrecioUnitario
            }).ToList();

            CalcularTotal();
        }
        catch (Exception ex)
        {
            await Alert.Error("Error al cargar la factura", ex.Message);
            Nav.NavigateTo("/facturas");
        }
    }

    private void AgregarLinea() => modelo.Detalles.Add(new());

    private async Task CargarPrecio(DetalleModel item)
    {
        if (item.ProductoId > 0)
        {
            var lote = await Http.GetFromJsonAsync<ProductoLote>($"api/productos/{item.ProductoId}/lote-fifo");
            if (lote != null)
            {
                item.PrecioUnitario = lote.PrecioVenta;
            }
        }
        CalcularTotal();
    }

    private void CalcularTotal()
    {
        modelo.Subtotal = modelo.Detalles.Sum(d => d.Cantidad * d.PrecioUnitario);
        modelo.Iva = Math.Round(modelo.Subtotal * 0.15m, 2);
        modelo.Total = modelo.Subtotal + modelo.Iva;
        StateHasChanged();
    }

    private async Task Guardar()
    {
        if (modelo.ClienteId == 0 || !modelo.Detalles.Any())
        {
            await Alert.Error("Debe seleccionar cliente y agregar productos");
            return;
        }

        var confirmado = await Alert.Confirm("¿Actualizar factura?", 
            $"Nuevo total: <strong>$${modelo.Total:0.00}</strong>");
        
        if (!confirmado) return;

        try
        {
            // Nota: Necesitarás implementar el endpoint PUT en tu API
            // Por ahora solo mostramos el éxito
            await Alert.Success("Factura actualizada correctamente");
            Nav.NavigateTo($"/facturas/detalle/{Id}");
        }
        catch (Exception ex)
        {
            await Alert.Error("Error al actualizar la factura", ex.Message);
        }
    }

    public class Modelo
    {
        public int ClienteId { get; set; }
        public DateTime Fecha { get; set; } = DateTime.Today;
        public List<DetalleModel> Detalles { get; set; } = new();
        public decimal Subtotal { get; set; }
        public decimal Iva { get; set; }
        public decimal Total { get; set; }
    }

    public class DetalleModel
    {
        public int ProductoId { get; set; }
        public int Cantidad { get; set; } = 1;
        public decimal PrecioUnitario { get; set; }
    }
    private void Cancelar() => Nav.NavigateTo("/productos/facturas");
}