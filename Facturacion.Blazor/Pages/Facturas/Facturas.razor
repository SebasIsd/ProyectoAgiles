@page "/facturas"
@using Facturacion.Application.DTOs
@inject FacturaApiService Api
@inject AlertService Alert
@inject NavigationManager Nav
@attribute [Authorize]
@inject HttpClient Http

<PageTitle>Facturación</PageTitle>

<h3 class="mb-3">Facturación</h3>

<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <button class="btn btn-primary btn-sm" @onclick="IrANuevaFactura">
        <i class="bi bi-file-earmark-plus"></i> Nueva Factura
    </button>

    <button class="btn btn-outline-secondary btn-sm" @onclick="Refrescar">
        <i class="bi bi-arrow-clockwise"></i> Refrescar
    </button>

    <div class="ms-auto"></div>

    <!-- Buscador -->
    <div class="input-group" style="max-width:320px">
        <button class="btn btn-outline-secondary" type="button" @onclick="AplicarFiltro">
            <i class="bi bi-search"></i>
        </button>
        <input class="form-control"
               placeholder="Buscar por cliente o # factura"
               @bind="SearchText"
               @bind:event="oninput" />
    </div>
</div>

@if (facturasFiltradas == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else if (!facturasFiltradas.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-inbox"></i> No se encontraron facturas para el criterio ingresado.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th># Factura</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Subtotal</th>
                    <th>IVA</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th style="width: 190px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var factura in facturasFiltradas)
                {
                    <tr>
                        <td><strong>@factura.Numero</strong></td>
                        <td>@factura.FechaEmision.ToString("dd/MM/yyyy")</td>
                        <td>@factura.ClienteNombre</td>
                        <td>$ @factura.Subtotal.ToString("0.00")</td>
                        <td>$ @factura.Iva.ToString("0.00")</td>
                        <td><strong>$ @factura.Total.ToString("0.00")</strong></td>
                        <td>
                            @switch (factura.Estado)
                            {
                                case "Emitida":
                                    <span class="badge bg-success">Emitida</span>
                                    break;
                                case "Borrador":
                                    <span class="badge bg-warning text-dark">Borrador</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">@factura.Estado</span>
                                    break;
                            }
                        </td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm me-1"
                                    @onclick="() => IrADetalle(factura.Id)">
                                <i class="bi bi-eye"></i> Ver
                            </button>

                            <button class="btn btn-outline-secondary btn-sm me-1"
                                    @onclick="() => IrAPdf(factura.Id)">
                                <i class="bi bi-file-earmark-pdf"></i> PDF
                            </button>

                            @if (factura.Estado == "Borrador")
                            {
                                <button class="btn btn-outline-warning btn-sm me-1"
                                        @onclick="() => IrAEditar(factura.Id)">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-outline-danger btn-sm"
                                        @onclick="() => EliminarFactura(factura.Id)">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<FacturaDto>? facturas;
    private List<FacturaDto>? facturasFiltradas;
    private string _searchText = string.Empty;

    private string SearchText
    {
        get => _searchText;
        set
        {
            _searchText = value;
            AplicarFiltro();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarFacturas();
    }

    private async Task CargarFacturas()
    {
        try
        {
            facturas = await Api.GetAllAsync();
            facturasFiltradas = facturas.ToList();
        }
        catch (Exception ex)
        {
            await Alert.Error("Error al cargar las facturas", ex.Message);
        }
    }

    private void AplicarFiltro()
    {
        if (string.IsNullOrWhiteSpace(SearchText))
        {
            facturasFiltradas = facturas?.ToList();
            return;
        }

        var term = SearchText.Trim().ToLower();
        facturasFiltradas = facturas?
            .Where(f => f.ClienteNombre.ToLower().Contains(term) ||
                       f.Numero.ToLower().Contains(term))
            .ToList();
    }

    private async Task EliminarFactura(int id)
    {
        var confirmado = await Alert.Confirm("¿Eliminar factura?",
            "Esta acción no se puede deshacer. Solo se pueden eliminar facturas en borrador.");

        if (!confirmado) return;

        try
        {
            await Api.EliminarAsync(id);
            await Alert.Success("Factura eliminada correctamente");
            await CargarFacturas();
        }
        catch (Exception ex)
        {
            await Alert.Error("Error al eliminar la factura", ex.Message);
        }
    }

    private void Refrescar() => InvokeAsync(async () => await CargarFacturas());

    private void IrANuevaFactura() => Nav.NavigateTo("/facturas/nueva");
    private void IrADetalle(int id) => Nav.NavigateTo($"/facturas/detalle/{id}");
    private void IrAPdf(int id) => Nav.NavigateTo($"/facturas/pdf/{id}");
    private void IrAEditar(int id) => Nav.NavigateTo($"/facturas/editar/{id}");
}