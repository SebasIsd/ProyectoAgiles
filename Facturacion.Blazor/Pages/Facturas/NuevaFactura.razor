@page "/facturas/nueva"
@inject FacturaApi Api
@inject NavigationManager Nav
@using Facturacion.Blazor.Models

<h3 class="mb-3">Nueva Factura</h3>

<EditForm Model="@Factura" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- ================= DATOS GENERALES ================= -->
    <div class="card mb-3">
        <div class="card-header">Datos Generales</div>
        <div class="card-body row g-3">
            <div class="col-md-4">
                <label class="form-label">Cliente</label>
                <InputSelect class="form-select" @bind-Value="Factura.ClienteId">
                    <option value="">Seleccione...</option>
                    @foreach (var c in Clientes)
                    {
                        <option value="@c.Id">@c.Nombre</option>
                    }
                </InputSelect>
            </div>

            <div class="col-md-4">
                <label class="form-label">Fecha</label>
                <InputDate class="form-control" @bind-Value="Factura.Fecha" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Número</label>
                <InputText class="form-control" @bind-Value="Factura.Numero" />
            </div>
        </div>
    </div>

    <!-- ==================== IVA ===================== -->
    <div class="card mb-3">
        <div class="card-header">Impuesto IVA</div>
        <div class="card-body">

            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">IVA estándar</label>
                    <InputSelect class="form-select"
                                 disabled="@Factura.UsarIvaPersonalizado"
                                 @bind-Value="Factura.IvaPorcentajeSeleccionado"
                                 @onchange="OnIvaChange">
                        <option value="0">0 %</option>
                        <option value="15">15 %</option>
                    </InputSelect>
                </div>

                <div class="col-md-4">
                    <div class="form-check mt-4">
                        <InputCheckbox class="form-check-input"
                                       @bind-Value="Factura.UsarIvaPersonalizado"
                                       @onchange="OnIvaPersonalizadoChange" />
                        <label class="form-check-label">Usar IVA personalizado</label>
                    </div>
                </div>
            </div>

            @if (Factura.UsarIvaPersonalizado)
            {
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label">IVA personalizado (%)</label>
                        <InputNumber class="form-control"
                                     @bind-Value="Factura.IvaPorcentajePersonalizado"
                                     @oninput="(_)=>RecalcularTotales()" />
                    </div>

                    <div class="col-md-9">
                        <label class="form-label">Justificación</label>
                        <InputTextArea class="form-control"
                                       @bind-Value="Factura.JustificacionIva"
                                       rows="2" />
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(mensajeErrorIva))
            {
                <div class="text-danger">@mensajeErrorIva</div>
            }

        </div>
    </div>

    <!-- ==================== PRODUCTOS ===================== -->
    <div class="card mb-3">
        <div class="card-header">Productos</div>
        <div class="card-body">

            @foreach (var d in Factura.Detalles)
            {
                <div class="row g-3 align-items-end mb-2">

                    <div class="col-md-5">
                        <label class="form-label">Producto</label>
                        <InputSelect class="form-select" @bind-Value="d.ProductoLoteId"
                                     @onchange="(_)=>OnProductoSeleccionado(d)">
                            <option value="">-- Seleccione --</option>
                            @foreach (var l in Lotes)
                            {
                                <option value="@l.Id">@l.Producto.Nombre (@l.Lote)</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Precio</label>
                        <input class="form-control" value="@d.Precio.ToString("0.00")" readonly />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Cantidad</label>
                        <InputNumber class="form-control"
                                     @bind-Value="d.Cantidad"
                                     @oninput="(_)=>OnCantidadChange(d)" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Subtotal</label>
                        <input class="form-control"
                               value="@d.Subtotal.ToString("0.00")"
                               readonly />
                    </div>

                    <div class="col-md-1">
                        <button type="button"
                                class="btn btn-danger btn-sm"
                                @onclick="(()=>RemoveDetalle(d))">X</button>
                    </div>

                </div>
            }

            <button class="btn btn-secondary" type="button" @onclick="AddDetalle">
                + Agregar Producto
            </button>

        </div>
    </div>

    <!-- ==================== RESUMEN ===================== -->
    <div class="card mb-3">
        <div class="card-header">Resumen</div>
        <div class="card-body row g-3">
            <div class="col-md-4">
                <label class="form-label">Subtotal</label>
                <input class="form-control" value="@Factura.Subtotal.ToString("0.00")" readonly />
            </div>
            <div class="col-md-4">
                <label class="form-label">IVA (@Factura.IvaAplicadoPorcentaje %)</label>
                <input class="form-control" value="@Factura.IvaMonto.ToString("0.00")" readonly />
            </div>
            <div class="col-md-4">
                <label class="form-label">Total</label>
                <input class="form-control" value="@Factura.Total.ToString("0.00")" readonly />
            </div>
        </div>
    </div>

    <button class="btn btn-primary">Guardar</button>
</EditForm>

@code {
    FacturaVm Factura = new();
    List<Cliente> Clientes = new();
    List<LoteVm> Lotes = new();

    private string? mensajeErrorIva;

    protected override async Task OnInitializedAsync()
    {
        Factura.Fecha = DateTime.Today;

        Clientes = await Api.GetClientes();
        Lotes = await Api.GetLotes();

        AddDetalle();
        RecalcularTotales();
    }

    void AddDetalle()
    {
        Factura.Detalles.Add(new FacturaDetalleVm
        {
            Cantidad = 1,
            Precio = 0
        });
    }

    void RemoveDetalle(FacturaDetalleVm d)
    {
        Factura.Detalles.Remove(d);
        RecalcularTotales();
    }

    private void OnProductoSeleccionado(FacturaDetalleVm d)
    {
        var lote = Lotes.FirstOrDefault(x => x.Id == d.ProductoLoteId);
        if (lote != null)
            d.Precio = lote.Precio;

        d.Subtotal = d.Cantidad * d.Precio;
        RecalcularTotales();
    }

    private void OnCantidadChange(FacturaDetalleVm d)
    {
        if (d.Cantidad < 0) d.Cantidad = 0;
        d.Subtotal = d.Cantidad * d.Precio;
        RecalcularTotales();
    }

    private void OnIvaChange(ChangeEventArgs _) => RecalcularTotales();

    private void OnIvaPersonalizadoChange(ChangeEventArgs _)
    {
        if (!Factura.UsarIvaPersonalizado)
        {
            Factura.IvaPorcentajePersonalizado = null;
            Factura.JustificacionIva = null;
        }
        RecalcularTotales();
    }

    private void RecalcularTotales()
    {
        mensajeErrorIva = null;

        Factura.Subtotal = Factura.Detalles.Sum(d => d.Subtotal);

        decimal iva =
            Factura.UsarIvaPersonalizado && Factura.IvaPorcentajePersonalizado.HasValue
            ? Factura.IvaPorcentajePersonalizado.Value
            : Factura.IvaPorcentajeSeleccionado;

        if (iva < 0) iva = 0;

        Factura.IvaAplicadoPorcentaje = iva;
        Factura.IvaMonto = Math.Round(Factura.Subtotal * iva / 100m, 2);
        Factura.Total = Factura.Subtotal + Factura.IvaMonto;
    }

    async Task Guardar()
    {
        if (Factura.UsarIvaPersonalizado)
        {
            if (!Factura.IvaPorcentajePersonalizado.HasValue ||
                Factura.IvaPorcentajePersonalizado <= 0 ||
                string.IsNullOrWhiteSpace(Factura.JustificacionIva))
            {
                mensajeErrorIva = "Debes indicar porcentaje y justificación.";
                return;
            }
        }

        await Api.Create(Factura);
        Nav.NavigateTo("/facturas");
    }
}
