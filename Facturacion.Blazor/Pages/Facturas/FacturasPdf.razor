@page "/facturas/pdf/{Id:int}"
@using Facturacion.Application.DTOs
@using System.Net.Http.Json
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Nav
@attribute [Authorize]
@inject AlertService Alert
@inject IJSRuntime JS

@if (factura == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
        <p class="mt-3">Cargando factura...</p>
    </div>
}
else
{
    <div id="factura-container" class="a4-page">
        <style>
            .a4-page {
                width: 210mm;
                min-height: 297mm;
                margin: 10mm auto;
                background: white;
                padding: 15mm;
                font-family: Arial, sans-serif;
                font-size: 10.5pt;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            @@media print {
                body, .a4-page { margin: 0; padding: 10mm; background: white; box-shadow: none; }
                .no-print { display: none !important; }
            }
            .header { background: #1e40af; color: white; padding: 12px; border-radius: 6px; }
            .text-blue { color: #1e40af; }
            .border-blue { border: 2px solid #1e40af; border-radius: 6px; }
            table { width: 100%; border-collapse: collapse; }
            th { background: #1e40af; color: white; }
            .total-row { background: #1e40af; color: white; font-weight: bold; }
            .logo { max-height: 70px; }
        </style>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col-7">
                <img src="/img/logo.png" alt="Logo" class="logo mb-3" /> <!-- TU LOGO REAL -->
                <h5 class="fw-bold text-blue">FACTURA EXPRESS S.R.L.</h5>
                <div class="small">
                    Av. Los Chasquis y Río Payamino<br />
                    Ambato - Ecuador<br />
                    Tel: 098 700 0000<br />
                    facturacion.express@gmail.com
                </div>
            </div>
            <div class="col-5 text-end">
                <div class="header">
                    <h1 class="mb-1">FACTURA</h1>
                    <h3># @factura.Numero</h3>
                    <p><strong>Fecha:</strong> @factura.FechaEmision:dd/MM/yyyy</p>
                    <p><strong>Pago:</strong> 30 días</p>
                </div>
            </div>
        </div>
        <!-- CLIENTE - ENVIAR A -->
        <div class="border-blue p-4 mb-4 bg-light">
            <h6 class="header-blue mb-3 px-2 py-1 rounded">
                <strong>ENVIAR A:</strong>
            </h6>

            <div class="row ms-1">
                <div class="col-4 fw-bold text-secondary">Cliente:</div>
                <div class="col-8">@(factura.ClienteNombre ?? "No especificado")</div>

                @if (!string.IsNullOrWhiteSpace(factura.ClienteDireccion))
                {
                    <div class="col-4 fw-bold text-secondary">Dirección:</div>
                    <div class="col-8">@factura.ClienteDireccion</div>
                }

                @if (!string.IsNullOrWhiteSpace(factura.ClienteTelefono))
                {
                    <div class="col-4 fw-bold text-secondary">Teléfono:</div>
                    <div class="col-8">@factura.ClienteTelefono</div>
                }

                @if (!string.IsNullOrWhiteSpace(factura.ClienteEmail))
                {
                    <div class="col-4 fw-bold text-secondary">Email:</div>
                    <div class="col-8">@factura.ClienteEmail</div>
                }

                @if (!string.IsNullOrWhiteSpace(factura.ClienteIdentificacion))
                {
                    <div class="col-4 fw-bold text-secondary">
                        @(string.IsNullOrEmpty(factura.ClienteTipoIdentificacion) ? "Identificación:" : factura.ClienteTipoIdentificacion + ":")
                    </div>
                    <div class="col-8">@factura.ClienteIdentificacion</div>
                }
            </div>
        </div>
        <!-- TABLA PRODUCTOS -->
        <table class="table table-bordered mb-4">
            <thead>
                <tr>
                    <th>DESCRIPCIÓN</th>
                    <th class="text-center">CANT.</th>
                    <th class="text-end">P. UNITARIO</th>
                    <th class="text-end">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in factura.Detalles)
                {
                    <tr>
                        <td>@d.ProductoNombre</td>
                        <td class="text-center">@d.Cantidad</td>
                        <td class="text-end">$ @d.PrecioUnitario</td>
                        <td class="text-end">$ @d.TotalLinea</td>
                    </tr>
                }
                <!-- Solo 7 filas vacías → cabe perfecto en 1 página -->
                @for (int i = factura.Detalles.Count; i < 7; i++)
                {
                    <tr><td colspan="4" style="height:28px;">&nbsp;</td></tr>
                }
            </tbody>
        </table>

        <!-- TOTALES -->
        <div class="row justify-content-end">
            <div class="col-5">
                <table class="table table-bordered">
                    <tr>
                        <td class="text-end fw-bold">SUBTOTAL</td>
                        <td class="text-end">$ @factura.Subtotal</td>
                    </tr>
                    <tr>
                        <td class="text-end fw-bold">IVA 15%</td>
                        <td class="text-end">$ @factura.Iva</td>
                    </tr>
                    <tr class="total-row">
                        <td class="text-end fs-5">TOTAL</td>
                        <td class="text-end fs-4">$ @factura.Total</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- GRACIAS -->
        <div class="text-center mt-5 pt-4 border-top">
            <h2 class="text-blue">¡GRACIAS POR SU COMPRA!</h2>
            <p class="text-muted small">
                Contáctenos: 098 700 0000 • facturacion.express@gmail.com
            </p>
        </div>
    </div>

    <!-- BOTONES -->
    <div class="text-center my-4 no-print">
        <button class="btn btn-secondary btn-lg ms-3" @onclick="Volver">
            Volver
        </button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private FacturaDto? factura;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            factura = await Http.GetFromJsonAsync<FacturaDto>($"api/facturas/{Id}");

            if (factura == null)
            {
                await Alert.Error("Factura no encontrada");
                Nav.NavigateTo("/facturas");
            }
        }
        catch (Exception ex)
        {
            await Alert.Error("Error al cargar la factura", ex.Message);
        }
    }

    private void Volver() => Nav.NavigateTo("/facturas");
}