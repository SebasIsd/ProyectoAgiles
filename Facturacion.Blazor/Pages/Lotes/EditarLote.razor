@page "/lotes/editar/{LoteId:int}"
@using Facturacion.Blazor.Services
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Nav
@inject LoteState LoteState

<PageTitle>Editar Lote</PageTitle>

<h3 class="mb-3">Editar Lote</h3>

@if (modelo is null)
{
    <div class="alert alert-warning">
        No se encontró el lote solicitado.
    </div>
}
else
{
    <EditForm Model="@modelo" OnValidSubmit="@Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card mb-3">
            <div class="card-header">Información del lote</div>
            <div class="card-body">
                <p>
                    <strong>ID Lote:</strong> @modelo.LoteId<br />
                    <strong>Producto:</strong> @productoDescripcion
                </p>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Fecha de expiración</label>
                        <InputDate class="form-control"
                                   DateFormat="dd/MM/yyyy"
                                   @bind-Value="modelo.FechaExpiracion" />
                        <ValidationMessage For="@(() => modelo.FechaExpiracion)" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Precio costo</label>
                        <InputNumber class="form-control"
                                     @bind-Value="modelo.PrecioCosto" />
                        <ValidationMessage For="@(() => modelo.PrecioCosto)" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">PVP</label>
                        <InputNumber class="form-control"
                                     @bind-Value="modelo.PVP" />
                        <ValidationMessage For="@(() => modelo.PVP)" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Cantidad disponible</label>
                        <InputNumber class="form-control"
                                     @bind-Value="modelo.CantidadDisponible" />
                        <ValidationMessage For="@(() => modelo.CantidadDisponible)" />
                    </div>
                </div>

                <div class="form-check mt-3">
                    <InputCheckbox class="form-check-input"
                                   @bind-Value="modelo.ForzarActualizacionPVP" />
                    <label class="form-check-label">
                        Forzar actualización de PVP
                    </label>
                </div>

                <!-- IMPORTACIÓN -->
                <div class="row g-3 mt-3">
                    <div class="col-md-3 d-flex align-items-center">
                        <div class="form-check">
                            <InputCheckbox class="form-check-input"
                                           @bind-Value="modelo.EsImportado" />
                            <label class="form-check-label">
                                Lote importado
                            </label>
                        </div>
                    </div>

                    @if (modelo.EsImportado)
                    {
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check">
                                <InputCheckbox class="form-check-input"
                                               @bind-Value="modelo.EsImportacion4x4" />
                                <label class="form-check-label">
                                    Importación 4x4 (≤ 4kg, ≤ $400)
                                </label>
                            </div>
                        </div>
                    }
                </div>

            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" @onclick="Cancelar">
                Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
                Guardar cambios
            </button>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int LoteId { get; set; }

    private ActualizarLoteViewModel? modelo;
    private string productoDescripcion = string.Empty;

    protected override void OnInitialized()
    {
        var lote = LoteState.GetById(LoteId);
        if (lote is null) return;

        modelo = new ActualizarLoteViewModel
        {
            LoteId = lote.LoteId,
            FechaExpiracion = lote.FechaExpiracion,
            PrecioCosto = lote.PrecioCosto,
            PVP = lote.PVP,
            CantidadDisponible = lote.CantidadDisponible,
            ForzarActualizacionPVP = false,
            EsImportado = lote.EsImportado,
            EsImportacion4x4 = lote.EsImportacion4x4
        };

        productoDescripcion = $"{lote.ProductoCodigo} - {lote.ProductoNombre}";
    }

    private void Guardar()
    {
        if (modelo is null) return;

        var loteActualizado = new LoteItem
        {
            LoteId = modelo.LoteId,
            FechaExpiracion = modelo.FechaExpiracion,
            PrecioCosto = modelo.PrecioCosto,
            PVP = modelo.PVP,
            CantidadDisponible = modelo.CantidadDisponible,
            EsImportado = modelo.EsImportado,
            EsImportacion4x4 = modelo.EsImportacion4x4
        };

        LoteState.Update(loteActualizado);
        Nav.NavigateTo("/lotes");
    }

    private void Cancelar() => Nav.NavigateTo("/lotes");

    // === ViewModel que replica ActualizarLoteDto ===
    private class ActualizarLoteViewModel
    {
        [Required(ErrorMessage = "El ID del lote es obligatorio")]
        public int LoteId { get; set; }

        public DateTime? FechaExpiracion { get; set; }

        [Required(ErrorMessage = "El precio de costo es obligatorio")]
        [Range(0.01, double.MaxValue, ErrorMessage = "El precio de costo debe ser mayor a 0")]
        public decimal PrecioCosto { get; set; }

        [Required(ErrorMessage = "El PVP es obligatorio")]
        [Range(0.01, double.MaxValue, ErrorMessage = "El PVP debe ser mayor a 0")]
        public decimal PVP { get; set; }

        [Required(ErrorMessage = "La cantidad disponible es obligatoria")]
        [Range(0, int.MaxValue, ErrorMessage = "La cantidad disponible no puede ser negativa")]
        public int CantidadDisponible { get; set; }

        public bool ForzarActualizacionPVP { get; set; } = false;

        // NUEVOS CAMPOS (importación)
        public bool EsImportado { get; set; }
        public bool EsImportacion4x4 { get; set; }
    }
}